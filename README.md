# Learning flortaucipir patterns with NMF

This repository contains public code for Tom's project (applying non-negative matrix factorization to flortaucipir images).

## Usage

### Setup

0. Make sure you have installed the [required software](#requirements).
1. Download this repository (either with git or GitHub).
2. [Download and supply the necessary data from ADNI & OASIS3](#downloading-raw-data)
3. Start a new terminal in your copy of the download repository.

### Run

Once you have completed the setup steps, you can try using some of the provided shell scripts to reproduce analyses & figures locally:

- `run_build_datasets.sh` should be run first.  This will create several tables in the `derivatives` folder for both the ADNI & OASIS3 datasets.
- `run_all_figures.sh` will iteratively run the plot creation scripts in each figure folder (`figure/fig#`).  You can alternatively run any individual figure by entering a figure folder and running the script `run_fig#.sh`.  Each script creates tables and graphs within their respective folder.  There are a few specific notes about running the figures:
  - Figures can only be run after the outputs created by `run_build_datasets.sh` have been generated.
  - Several figures can only be run after previous figures have been run (e.g., the longitudinal staging in Figure 4 can only be created after the cross-sectional staging in Figure 2).
  - Figure 6 can only be run after the gene-expression correlations have been run for Table 2 (`tables/table2`).

### Rerunning NMF (optional)

**Note that NMF is NOT rerun by default.**  Instead, this repository comes with the NMF outputs that were originally generated (stored in `nmf/adni/results/mat` and `nmf/oasis3/results/mat`).  This ensures that all analyses are run using the same components as I had.

To rerun the NMF for a dataset, the MATLAB script `nmf/adni/run_nmf.m` can be used (and the equivalent for OASIS3).  This will **regenerate and overwrite** the outputs in `nmf/adni/results/mat`.  On my laptop, this takes only a couple minutes.

The intra-sample reproducibility analysis is also not rerun by default (Figure 1, panels B & E).  The data required for creating this plot are stored in `nmf/adni/results/repeat_reproducibility_mat/reproducibilityResults.mat` (and the equivalent for OASIS3).  This file can be regenerated by using `run_repeated_reproducibility.m` and subsequently `evaluate_repeated_reproducibility.m`.  **On my laptop, the first script takes several hours to run.**  

## Requirements

This project used the following languages:

- Python (3.8.3)
- R (4.2.0)
- MATLAB (2022b)

Specific packages required for R and Python are provided in the `requirements_python.txt` and `requirements_r.txt` files.

BASH scripts are also used for stitching together other scripts.

## Downloading raw data

This repository does not include data from ADNI/OASIS which require approval to access.  This section will document the instructions for accessing the data necessary for this project.

**All files described here (for both ADNI & OASIS) should be placed in the `rawdata` folder.**   Note that some files will need to be renamed.

### ADNI

- **ADNIMERGE R package**
  - https://ida.loni.usc.edu/ > ADNI > Download > Study Data > Study Info > Data & Database > ADNIMERGE - Key ADNI tables merged into one table - Packages for R [ADNI1,GO,2]
  - Follow instructions for installation here: https://adni.bitbucket.io/
  - Data for this project were download on November 23, 2022
- **PTDEMOG.csv**
  - https://ida.loni.usc.edu/ > ADNI > Download > Study Data > Subject Characteristics > Subject Demographics > Subject Demographics [ADNI1,GO,2,3]
  - This file was specifically downloaded to find some demographic information missing from ADNIMERGE R.

### OASIS-3

- **Amyloid PUP results**
  - https://central.xnat.org/ > Browse > My Projects > OASIS3 > Add Tab > PUPs > Options > Edit Columns > Add column "PET_fSUVR_rsf_TOT_CORTMEAN" > Options > Spreadsheet
  - **RENAME THIS FILE:** `oasis_amyloid.csv`
- **Flortaucipir PUP results**
  - https://central.xnat.org/ > Browse > My Projects > OASIS3_AV1451 > Add Tab > PUPs > Options > Edit Columns > Add all columns containing "fSUVR" (the ones containing "rsf" are not needed, but can be included) > Options > Spreadsheet
  - **RENAME THIS FILE:** `oasis_flortaucipir.csv`
- **OASIS3 Data Files**
  - https://central.xnat.org/ > Browse > My Projects > OASIS3 > On the "Subjects" tab, click "0AS_data_files" > Click "MR Session" next to "OASIS3_data_files" > Select all entries ("demo through DUT") > Bulk Actions: Download.
  - Unzip the downloaded folder, and place it in the `rawdata` folder.  This folder should be called "OASIS3_data_files" (it should not have to be renamed).

## Troubleshooting

Please log any issues for trouble running or reproducing analyses.  Before doing so, note:

- Make sure you have the required software and packages installed and available.
- Make sure you have added the required data from ADNI & OASIS3
- Some (hopefully small) deviation in results is expected.  This could be because:
  - I forgot to seed some analysis that has a random component
  - *The data provided by ADNI or OASIS have been updated*.  This should not be an issue for OASIS-3 which has a stable release, but may be an issue for the ADNI.  The ADNIMERGE R package is not meaningfully versioned, and can only be compared based on the date of download (the version I originally used is from November, 2022).  I have included a list of the subjects I used in the `subject_lists` folder, which is used to filter the subjects going into the main subject tables being created.   However, this will not account for other assessments which are linked to these subjects (e.g., CDR scores, amyloid imaging, etc.)
